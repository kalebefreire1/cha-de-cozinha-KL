<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presentes | Chá de Cozinha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-display {
            font-family: 'Playfair Display', serif;
        }
        /* Animação de fade-in para o modal */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 300ms, transform 300ms;
        }
        #gift-list-container.hidden, #loading-state.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-pink-50 text-gray-800">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-8 text-center">
            <h1 class="font-display text-4xl md:text-5xl text-pink-800">Chá de Cozinha</h1>
            <p class="text-2xl text-gray-600 mt-2">Kalebe & Larissa</p>
            
            <img src="https://64.media.tumblr.com/2677137799ef9f5941362148789681a6/9330d53afbb73c1e-e6/s540x810/c85669f08a4577052dcc89bd897f2c54b955f472.gif" alt="Gatinho cozinhando" class="w-24 h-24 mx-auto my-6 rounded-full object-cover">

            <!-- Informações do Evento -->
            <div class="mt-6 flex flex-col md:flex-row justify-center items-center space-y-3 md:space-y-0 md:space-x-8 text-gray-600">
                <a href="https://www.google.com/calendar/render?action=TEMPLATE&text=Ch%C3%A1%20de%20Cozinha%20-%20Kalebe%20%26%20Larissa&dates=20251130T163000Z/20251130T193000Z&details=Ch%C3%A1%20de%20Cozinha%20de%20Kalebe%20%26%20Larissa.&location=Buffet%20Residencial%20Jasmim%20-%20Jundia%C3%AD%2C%20SP" target="_blank" rel="noopener noreferrer" class="flex items-center hover:text-pink-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-pink-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                    <span>30 de Novembro de 2025</span>
                </a>
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-pink-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z" clip-rule="evenodd" /></svg>
                    <span>às 13:30</span>
                </div>
                <a href="https://maps.app.goo.gl/9VVqtqYaCt18rQQT9" target="_blank" rel="noopener noreferrer" class="flex items-center hover:text-pink-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-pink-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                    <span>Buffet Residencial Jasmim - Jundiaí, SP</span>
                </a>
            </div>
            
            <p id="header-text" class="text-gray-500 max-w-2xl mx-auto mt-6"></p>
            <p class="mt-4 text-sm text-gray-500 max-w-2xl mx-auto italic">Os preços e links são apenas sugestões. Sinta-se à vontade para comprar em sua loja de preferência! Ao final da página há um botão para apenas confirmar a presença.</p>
        </div>
    </header>

    <!-- Estado de Carregamento -->
    <div id="loading-state" class="text-center py-20">
        <svg class="animate-spin h-8 w-8 text-pink-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <p class="mt-4 text-gray-600">Carregando lista de presentes...</p>
    </div>

    <!-- Lista de Presentes -->
    <main id="gift-list-container" class="container mx-auto px-6 py-12 hidden">
        <div id="gift-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Os cards de presentes serão inseridos aqui pelo JavaScript -->
        </div>
        
        <div id="confirm-only-button-container" class="text-center mt-12 hidden">
            <button onclick="confirmPresenceOnly()" class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors shadow-md">Apenas Confirmar Presença</button>
            <p class="text-xs text-gray-500 mt-2">Você pode voltar mais tarde para escolher um presente.</p>
        </div>
    </main>
    
    <!-- Rodapé e Modais (sem alterações) -->
    <footer class="text-center py-6 text-gray-500"><p>Feito com ❤️</p><div class="mt-4"><button onclick="showModal('password-modal')" class="text-xs text-gray-400 hover:text-pink-600 transition-colors">Acesso do Anfitrião</button></div></footer>
    <div id="rsvp-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-auto modal-enter text-center"><h2 class="text-2xl font-bold mb-4 text-gray-800">Bem-vindo(a)!</h2><p class="mb-6 text-gray-600">Para continuar, por favor, digite seu nome e confirme sua presença (ou ausência) no evento.</p><div><label for="rsvp-guest-name" class="block text-sm font-medium text-gray-700 mb-1 text-left">Seu nome completo</label><input type="text" id="rsvp-guest-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Digite seu nome aqui"><p id="rsvp-error-message" class="text-red-500 text-sm mt-1 hidden text-left">Por favor, preencha seu nome.</p></div><div class="mt-8 space-y-3"><button onclick="handleRSVP(true)" class="w-full px-6 py-3 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors shadow-md">Confirmar Presença</button><button onclick="handleRSVP(false)" class="w-full px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors shadow-md">Não poderei ir, mas quero presentear</button></div></div></div>
    <div id="companion-prompt-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-auto modal-enter text-center"><h2 class="text-2xl font-bold mb-4 text-gray-800">Acompanhantes</h2><p class="mb-8 text-gray-600">Você levará acompanhante(s) para o evento?</p><div class="flex justify-center space-x-4"><button onclick="handleCompanionPrompt(false)" class="px-8 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors shadow-md">Não</button><button onclick="handleCompanionPrompt(true)" class="px-8 py-3 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors shadow-md">Sim</button></div></div></div>
    <div id="companion-details-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-auto modal-enter text-center"><h2 class="text-2xl font-bold mb-4 text-gray-800">Dados dos Acompanhantes</h2><p id="companion-instructions" class="mb-6 text-gray-600">Por favor, preencha as informações de cada acompanhante para a lista da portaria.</p><div id="companion-list" class="text-left mb-4 text-sm text-gray-500 max-h-24 overflow-y-auto"></div><div><label for="companion-name" class="block text-sm font-medium text-gray-700 mb-1 text-left">Nome completo do acompanhante</label><input type="text" id="companion-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Digite o nome completo"><p id="companion-name-error" class="text-red-500 text-sm mt-1 hidden text-left">Por favor, preencha o nome.</p></div><div class="mt-4"><label for="companion-document" class="block text-sm font-medium text-gray-700 mb-1 text-left">Nº do Documento (RG ou CNH)</label><input type="text" id="companion-document" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Apenas números"><p id="companion-document-error" class="text-red-500 text-sm mt-1 hidden text-left">Por favor, preencha o documento.</p></div><div class="mt-8 flex flex-col sm:flex-row gap-3"><button onclick="addAnotherCompanion()" class="w-full px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Adicionar Outro</button><button onclick="finishCompanionRegistration()" class="w-full px-6 py-3 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors shadow-md">Finalizar e Continuar</button></div></div></div>
    <div id="document-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-auto modal-enter text-center"><h2 class="text-2xl font-bold mb-4 text-gray-800">Seu Acesso ao Evento</h2><p class="mb-6 text-gray-600">Agora, para finalizar, informe o seu documento de identificação (RG ou CNH) para a lista da portaria.</p><div><label for="guest-document" class="block text-sm font-medium text-gray-700 mb-1 text-left">Seu Nº de Documento (RG ou CNH)</label><input type="text" id="guest-document" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Apenas números"><p id="document-error-message" class="text-red-500 text-sm mt-1 hidden text-left">Por favor, preencha seu documento.</p></div><div class="mt-8"><button onclick="saveDocument()" class="w-full px-6 py-3 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors shadow-md">Salvar e Ver Presentes</button></div></div></div>
    <div id="reserve-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-auto modal-enter"><h2 class="text-2xl font-bold mb-4 text-gray-800">Confirmar Reserva</h2><p class="mb-6 text-gray-600">Você confirma a reserva do item: <strong id="modal-gift-name" class="text-pink-700"></strong>?</p><div class="mt-8 flex justify-end space-x-4"><button onclick="hideModal('reserve-modal')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button><button onclick="confirmReservation()" class="px-6 py-2 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors shadow-md">Sim, Confirmar</button></div></div></div>
    <div id="cancel-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-auto modal-enter"><h2 class="text-2xl font-bold mb-4 text-gray-800">Cancelar Reserva</h2><p class="mb-6 text-gray-600">Você tem certeza que deseja cancelar a reserva do item: <strong id="cancel-modal-gift-name" class="text-pink-700"></strong>?</p><div class="mt-8 flex justify-end space-x-4"><button onclick="hideModal('cancel-modal')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Voltar</button><button onclick="confirmCancellation()" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors shadow-md">Sim, Cancelar</button></div></div></div>
    <div id="givers-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg mx-auto modal-enter"><h2 class="text-2xl font-bold mb-6 text-gray-800">Lista de Convidados e Presentes</h2><div id="givers-list-content" class="text-gray-700 max-h-96 overflow-y-auto"></div><div class="mt-8 flex justify-end"><button onclick="hideModal('givers-modal')" class="px-6 py-2 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors">Fechar</button></div></div></div>
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm mx-auto modal-enter"><h2 class="text-2xl font-bold mb-4 text-gray-800">Acesso Restrito</h2><p class="mb-6 text-gray-600">Por favor, digite a senha de anfitrião para ver a lista.</p><div><label for="host-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label><input type="password" id="host-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Digite a senha"><p id="password-error-message" class="text-red-500 text-sm mt-1 hidden">Senha incorreta. Tente novamente.</p></div><div class="mt-8 flex justify-end space-x-4"><button onclick="hideModal('password-modal')" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button><button onclick="checkPassword()" class="px-6 py-2 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors shadow-md">Acessar</button></div></div></div>
    <div id="thank-you-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden"><div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm mx-auto modal-enter text-center"><h2 class="text-2xl font-bold mb-4 text-pink-700">Obrigado!</h2><p class="mb-6 text-gray-600">Sua presença foi confirmada com sucesso! Agradecemos seu carinho. Se mudar de ideia sobre o presente, basta visitar esta página novamente.</p><div class="mt-8 flex justify-end"><button onclick="hideModal('thank-you-modal')" class="px-6 py-2 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 transition-colors">Fechar</button></div></div></div>
    <audio id="background-music" loop><source src="https://cdn.pixabay.com/download/audio/2022/02/10/audio_2425232dc1.mp3?filename=lofi-chill-medium-version-159456.mp3" type="audio/mpeg">Seu navegador não suporta o elemento de áudio.</audio>
    <button id="play-pause-btn" class="fixed bottom-5 right-5 bg-pink-600 text-white p-3 rounded-full shadow-lg z-50 hover:bg-pink-700 transition-colors focus:outline-none"><svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><svg id="pause-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>

    <!-- Scripts do Firebase -->
    <script type="module">
        // Importações dos módulos do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, query, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- INÍCIO DA ÁREA DE CONFIGURAÇÃO DO FIREBASE ---
        // Siga o guia para criar seu projeto no Firebase e cole sua configuração aqui.
        const firebaseConfig = {
     	 apiKey: "AIzaSyDBtbOPBZliKsAzB-gkP7VpCuyQWrhwBVU",
     	 authDomain: "cha-de-cozinha-kalebe-larissa.firebaseapp.com",
     	 projectId: "cha-de-cozinha-kalebe-larissa",
     	 storageBucket: "cha-de-cozinha-kalebe-larissa.firebasestorage.app",
     	 messagingSenderId: "345870543781",
     	 appId: "1:345870543781:web:6fb8c06b18ded4c829164c",
     	 measurementId: "G-WFH6VRF6XM"
    	};
        // --- FIM DA ÁREA DE CONFIGURAÇÃO DO FIREBASE ---

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referências das coleções no Firestore
        const giftsCollection = collection(db, 'gifts');
        const guestsCollection = collection(db, 'guests');

        // --- INÍCIO DA ÁREA DE EDIÇÃO ---
        const hostPassword = '*chadecozinha';
        // --- FIM DA ÁREA DE EDIÇÃO ---

        // Elementos da página
        const giftListContainer = document.getElementById('gift-list');
        const giftListMainContainer = document.getElementById('gift-list-container');
        const loadingState = document.getElementById('loading-state');
        const rsvpModal = document.getElementById('rsvp-modal');
        const documentModal = document.getElementById('document-modal');
        const companionPromptModal = document.getElementById('companion-prompt-modal');
        const companionDetailsModal = document.getElementById('companion-details-modal');
        const reserveModal = document.getElementById('reserve-modal');
        const cancelModal = document.getElementById('cancel-modal');
        const giversModal = document.getElementById('givers-modal');
        const passwordModal = document.getElementById('password-modal');
        const thankYouModal = document.getElementById('thank-you-modal');
        const confirmOnlyButtonContainer = document.getElementById('confirm-only-button-container');
        const modalGiftName = document.getElementById('modal-gift-name');
        const cancelModalGiftName = document.getElementById('cancel-modal-gift-name');
        const rsvpGuestNameInput = document.getElementById('rsvp-guest-name');
        const rsvpErrorMessage = document.getElementById('rsvp-error-message');
        const guestDocumentInput = document.getElementById('guest-document');
        const documentErrorMessage = document.getElementById('document-error-message');
        const companionNameInput = document.getElementById('companion-name');
        const companionDocumentInput = document.getElementById('companion-document');
        const companionNameError = document.getElementById('companion-name-error');
        const companionDocumentError = document.getElementById('companion-document-error');
        const companionListDiv = document.getElementById('companion-list');
        const companionInstructions = document.getElementById('companion-instructions');
        const hostPasswordInput = document.getElementById('host-password');
        const passwordErrorMessage = document.getElementById('password-error-message');
        const giversListContent = document.getElementById('givers-list-content');
        const headerText = document.getElementById('header-text');

        let currentGiftId = null;
        let guestInfo = null;
        let appGifts = [];
        let currentUser = null;

        function renderGifts() {
            giftListContainer.innerHTML = '';
            // Ordena os presentes para que os não reservados apareçam primeiro
            const sortedGifts = [...appGifts].sort((a, b) => (a.reservedBy ? 1 : 0) - (b.reservedBy ? 1 : 0));

            sortedGifts.forEach(gift => {
                const isReserved = !!gift.reservedBy;
                const card = document.createElement('div');
                card.className = `bg-white rounded-xl shadow-lg overflow-hidden transition-transform transform hover:scale-105 flex flex-col ${isReserved ? 'opacity-60' : ''}`;
                
                let buttonHtml;
                if (isReserved) {
                    if (currentUser && gift.reservedBy.uid === currentUser.uid) {
                        buttonHtml = `<div class="p-6"><button onclick="window.app.showModal('cancel-modal', '${gift.id}')" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">Cancelar Reserva</button></div>`;
                    } else {
                        buttonHtml = `<div class="bg-green-100 text-green-800 text-center p-6"><p class="font-bold">Este presente já foi reservado!</p></div>`;
                    }
                } else {
                    buttonHtml = `<div class="p-6"><button onclick="window.app.showModal('reserve-modal', '${gift.id}')" class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 transition-colors shadow-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-opacity-50">Quero dar este presente!</button></div>`;
                }
                
                card.innerHTML = `<div class="relative"><img src="${gift.imageUrl}" alt="${gift.name}" class="w-full aspect-square object-cover">${isReserved ? '<div class="absolute inset-0 bg-black bg-opacity-30"></div>' : ''}</div><div class="p-6 flex-grow flex flex-col"><h3 class="text-xl font-bold text-gray-800">${gift.name}</h3><p class="text-gray-600 mt-2 flex-grow">${gift.description}</p><div class="mt-4 flex justify-between items-center"><span class="text-2xl font-bold text-pink-700">${gift.price}</span><a href="${gift.purchaseLink}" target="_blank" class="text-pink-600 hover:text-pink-800 font-semibold ${isReserved ? 'pointer-events-none' : ''}">Ver loja</a></div></div>${buttonHtml}`;
                giftListContainer.appendChild(card);
            });
        }
        
        // Colocando funções globais dentro de um objeto para evitar poluir o escopo global
        window.app = {
            showModal(modalId, giftId = null) {
                const modal = document.getElementById(modalId);
                if (giftId) {
                    const gift = appGifts.find(g => g.id === giftId);
                    if (gift) {
                        currentGiftId = giftId;
                        if (modalId === 'reserve-modal') modalGiftName.textContent = gift.name;
                        if (modalId === 'cancel-modal') cancelModalGiftName.textContent = gift.name;
                    }
                }
                modal.classList.remove('hidden');
                setTimeout(() => modal.querySelector('div.modal-enter').classList.add('modal-enter-active'), 10);
                if (modalId === 'rsvp-modal') rsvpGuestNameInput.focus();
                if (modalId === 'document-modal') guestDocumentInput.focus();
                if (modalId === 'companion-details-modal') companionNameInput.focus();
                if (modalId === 'password-modal') hostPasswordInput.focus();
            },

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                const modalContent = modal.querySelector('div.modal-enter');
                modalContent.classList.remove('modal-enter-active');
                modalContent.classList.add('modal-exit-active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modalContent.classList.remove('modal-exit-active');
                     if (modalId === 'password-modal') {
                        hostPasswordInput.value = '';
                        passwordErrorMessage.classList.add('hidden');
                        hostPasswordInput.classList.remove('border-red-500');
                    }
                }, 300);
            },
            
            async handleRSVP(isAttending) {
                const name = rsvpGuestNameInput.value.trim();
                if (!name) { rsvpErrorMessage.classList.remove('hidden'); rsvpGuestNameInput.classList.add('border-red-500'); return; }
                guestInfo = { name: name, attending: isAttending, document: null, companions: [] };
                
                app.hideModal('rsvp-modal');
                
                if (isAttending) {
                    app.showModal('companion-prompt-modal');
                } else {
                    await setDoc(doc(guestsCollection, currentUser.uid), guestInfo);
                    initializePage(currentUser);
                }
            },
            
            handleCompanionPrompt(hasCompanion) {
                app.hideModal('companion-prompt-modal');
                if (hasCompanion) {
                    companionNameInput.value = '';
                    companionDocumentInput.value = '';
                    companionInstructions.textContent = "Por favor, preencha as informações do seu acompanhante para a lista da portaria.";
                    updateCompanionList();
                    app.showModal('companion-details-modal');
                } else {
                    app.showModal('document-modal');
                }
            },

            addAnotherCompanion() {
                const companionData = validateCompanionForm();
                if (companionData) {
                    if (guestInfo) {
                        guestInfo.companions.push(companionData);
                        companionNameInput.value = '';
                        companionDocumentInput.value = '';
                        companionInstructions.textContent = "Acompanhante adicionado! Preencha os dados do próximo ou clique em 'Finalizar e Continuar'.";
                        updateCompanionList();
                        companionNameInput.focus();
                    }
                }
            },

            finishCompanionRegistration() {
                const name = companionNameInput.value.trim();
                const docValue = companionDocumentInput.value.trim();
                if (name || docValue) {
                    const companionData = validateCompanionForm();
                    if (companionData) {
                        if (guestInfo) { guestInfo.companions.push(companionData); } 
                        else { return; }
                    } else { return; }
                }
                app.hideModal('companion-details-modal');
                app.showModal('document-modal');
            },

            async saveDocument() {
                const docValue = guestDocumentInput.value.trim();
                if (!docValue) { documentErrorMessage.classList.remove('hidden'); guestDocumentInput.classList.add('border-red-500'); return; }
                if (guestInfo) {
                    guestInfo.document = docValue;
                    await setDoc(doc(guestsCollection, currentUser.uid), guestInfo);
                    app.hideModal('document-modal');
                    initializePage(currentUser);
                }
            },
            
            async confirmPresenceOnly() {
                if (guestInfo) {
                    await setDoc(doc(guestsCollection, currentUser.uid), guestInfo);
                    app.showModal('thank-you-modal');
                }
            },

            async checkPassword() {
                const enteredPassword = hostPasswordInput.value;
                if (enteredPassword === hostPassword) {
                    app.hideModal('password-modal');
                    await app.showGiversList();
                } else {
                    passwordErrorMessage.classList.remove('hidden');
                    hostPasswordInput.classList.add('border-red-500');
                }
            },

            async confirmReservation() {
                if (guestInfo && currentUser) {
                    await setDoc(doc(guestsCollection, currentUser.uid), guestInfo);
                    const giftRef = doc(giftsCollection, currentGiftId);
                    await updateDoc(giftRef, { reservedBy: { uid: currentUser.uid, name: guestInfo.name } });
                    app.hideModal('reserve-modal');
                }
            },
            
            async confirmCancellation() {
                const giftRef = doc(giftsCollection, currentGiftId);
                await updateDoc(giftRef, { reservedBy: null });
                app.hideModal('cancel-modal');
            },
            
            async showGiversList() {
                const guestsSnapshot = await getDocs(guestsCollection);
                const guests = guestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (guests.length === 0) {
                    giversListContent.innerHTML = '<p>Nenhum convidado confirmou presença ainda.</p>';
                } else {
                    let listHtml = '<ul class="space-y-4">';
                    guests.forEach(guest => {
                        const reservedGift = appGifts.find(gift => gift.reservedBy && gift.reservedBy.name === guest.name);
                        const rsvpStatus = guest.attending ? '<span class="text-xs font-semibold text-green-700 bg-green-100 px-2 py-1 rounded-full">PRESENÇA CONFIRMADA</span>' : '<span class="text-xs font-semibold text-orange-700 bg-orange-100 px-2 py-1 rounded-full">NÃO PODERÁ COMPARECER</span>';
                        const documentInfo = guest.attending && guest.document ? `<br><span class="text-sm text-gray-500">Documento:</span> <span class="text-gray-900">${guest.document}</span>` : '';
                        let companionInfo = '';
                        if (guest.companions && guest.companions.length > 0) {
                            companionInfo += '<div class="mt-2 pl-4 border-l-2 border-gray-200">';
                            guest.companions.forEach(comp => {
                                companionInfo += `<div class="mb-1"><span class="text-sm font-semibold text-gray-600">Acompanhante:</span> <span class="text-pink-700">${comp.name}</span><br><span class="text-sm text-gray-500">Documento:</span> <span class="text-gray-900">${comp.document}</span></div>`;
                            });
                            companionInfo += '</div>';
                        }
                        const giftInfo = reservedGift ? `<div class="mt-2"><span class="text-sm font-semibold text-gray-600">Presente Escolhido:</span> <span class="text-gray-900">${reservedGift.name}</span></div>` : `<div class="mt-2"><span class="text-sm font-semibold text-gray-600">Presente Escolhido:</span> <span class="text-gray-500 italic">Ainda não escolheu</span></div>`;
                        listHtml += `<li class="border-b pb-3"><div class="flex justify-between items-start"><div><span class="font-semibold text-lg text-gray-800">${guest.name}</span>${documentInfo}</div><div class="mt-1">${rsvpStatus}</div></div>${companionInfo}${giftInfo}</li>`;
                    });
                    listHtml += '</ul>';
                    giversListContent.innerHTML = listHtml;
                }
                app.showModal('givers-modal');
            }
        };
        // Fim do objeto window.app

        function updateCompanionList() {
            if (guestInfo && guestInfo.companions.length > 0) {
                companionListDiv.innerHTML = '<strong class="block mb-2">Acompanhantes adicionados:</strong><ul class="list-disc pl-5">' + guestInfo.companions.map(c => `<li>${c.name}</li>`).join('') + '</ul>';
            } else { companionListDiv.innerHTML = ''; }
        }

        function validateCompanionForm() {
            const name = companionNameInput.value.trim();
            const doc = companionDocumentInput.value.trim();
            let hasError = false;
            if (!name) { companionNameError.classList.remove('hidden'); companionNameInput.classList.add('border-red-500'); hasError = true; } 
            else { companionNameError.classList.add('hidden'); companionNameInput.classList.remove('border-red-500'); }
            if (!doc) { companionDocumentError.classList.remove('hidden'); companionDocumentInput.classList.add('border-red-500'); hasError = true; } 
            else { companionDocumentError.classList.add('hidden'); companionDocumentInput.classList.remove('border-red-500'); }
            return hasError ? null : { name, document: doc };
        }

        async function initializePage(user) {
            const guestRef = doc(guestsCollection, user.uid);
            const guestSnap = await getDoc(guestRef);
            
            if (guestSnap.exists()) {
                guestInfo = guestSnap.data();
                
                if (guestInfo.attending && !guestInfo.document) {
                    headerText.textContent = `Olá, ${guestInfo.name}! Faltam alguns passos para finalizar.`;
                    app.showModal('companion-prompt-modal');
                } else {
                    headerText.textContent = `Olá, ${guestInfo.name}! Sua presença é o maior presente! Mas, se desejar nos presentear, preparamos esta lista com muito carinho.`;
                    loadingState.classList.add('hidden');
                    giftListMainContainer.classList.remove('hidden');
                    confirmOnlyButtonContainer.classList.remove('hidden');
                    renderGifts();
                }
            } else {
                headerText.textContent = `Queridos amigos e familiares, sua presença é o maior presente! Para continuar, por favor, confirme sua presença.`;
                loadingState.classList.add('hidden');
                app.showModal('rsvp-modal');
            }
        }
        
        // Autenticação e inicialização
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                onSnapshot(query(giftsCollection), (snapshot) => {
                    appGifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    initializePage(user);
                });
            } else {
                signInAnonymously(auth).catch((error) => console.error("Erro na autenticação anônima:", error));
            }
        });

        // Event Listeners para fechar modais
        [rsvpModal, documentModal, companionPromptModal, companionDetailsModal, reserveModal, giversModal, passwordModal, cancelModal, thankYouModal].forEach(modal => {
            if (modal) {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal && !['rsvp-modal', 'document-modal', 'companion-prompt-modal', 'companion-details-modal'].includes(modal.id)) {
                        app.hideModal(modal.id);
                    }
                });
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                ['reserve-modal', 'cancel-modal', 'givers-modal', 'password-modal', 'thank-you-modal'].forEach(id => {
                    if (!document.getElementById(id).classList.contains('hidden')) app.hideModal(id);
                });
            }
        });

        // Lógica do Player de Música
        const backgroundMusic = document.getElementById('background-music');
        const playPauseBtn = document.getElementById('play-pause-btn');
        if (backgroundMusic && playPauseBtn) {
            const playIcon = playPauseBtn.querySelector('#play-icon');
            const pauseIcon = playPauseBtn.querySelector('#pause-icon');
            playPauseBtn.addEventListener('click', () => { backgroundMusic.paused ? backgroundMusic.play() : backgroundMusic.pause(); });
            backgroundMusic.addEventListener('play', () => { playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); });
            backgroundMusic.addEventListener('pause', () => { playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden'); });
            document.body.addEventListener('click', () => {
                let playPromise = backgroundMusic.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => console.log("A reprodução automática foi bloqueada."));
                }
            }, { once: true });
        }
    </script>
</body>
</html>

